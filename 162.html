<!DOCTYPE html>
<meta charset="utf-8">
<style>
  .link {
    stroke: #000;
    stroke-width: 1.5px;
  }
  .node {
    stroke: #2ca0ff;
  }
  .text {
    font: 10px sans-serif;
    pointer-events: none;
  }
</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

function happyfy (n) {
  return n.toString().split('')
    .map( function (n) { return Number(n) * Number(n) } )
    .reduce( function (a, b) { return a + b } )
}

var hLimit = 10
// var hLimit = 163

var d3Charge = -370
var d3LinkDistance = 60
var dimensions = Math.sqrt(Math.sqrt(hLimit) * (d3LinkDistance - d3Charge)) * 20
var width = dimensions
var height = dimensions

var color = d3.scale.category10()

var nodes = []
var links = []
var force = d3.layout.force()
    .nodes(nodes)
    .links(links)
    .charge(d3Charge)
    .linkDistance(d3LinkDistance)
    .size([width, height])
    .on("tick", tick)

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)

var node = svg.selectAll(".node")
var link = svg.selectAll(".link")

var sw = true

function tick() {
  node.attr("x", function(d) { return d.x; })
      .attr("y", function(d) { return d.y; })

  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; })
}

function start() {
  link = link.data(force.links(), function(d) { return d.source.id + "-" + d.target.id })
  link.enter().insert("line", ".node").attr("class", "link")
  link.exit().remove()

  node = node.data(force.nodes(), function(d) { return d.id })

  node.enter().append("text").attr("class", function(d) { return "node " + d.id }).text(function(d) { return d.id }).call(force.drag)

  // node.enter().append("circle").attr("class", function(d) { return "circle " + d.id }).attr("r", 10).call(force.drag)
  node.exit().remove()

  force.start()
}

var references = {}
var happyfied = {}
var addNodes = function (sourceId) {
  if (happyfied[sourceId]) { return }
  if (references[sourceId] === undefined) {
    references[sourceId] = nodes.length
    happyfied[sourceId] = nodes.length
    nodes.push( {id: sourceId, label:sourceId} )
  }
  var sourceNode = nodes[references[sourceId]]

  var targetId = happyfy(sourceId)

  if (sourceId !== targetId) {
    if (references[targetId] === undefined) {
      references[targetId] = nodes.length
      nodes.push( {id: targetId, label:targetId} )
    }
    var targetNode = nodes[references[targetId]]
    links.push( {source: sourceNode, target: targetNode} )
  }
  start()

  setTimeout(function () {
    addNodes(targetId)
  }, 567)

  if (sourceId < hLimit) {
    setTimeout(function () {
      addNodes(sourceId + 1)
    }, 1567)
  }
}
addNodes(1)

</script>
<!--
node.append("text")
.attr("x", 8)
.attr("y", ".31em")
.text(function(d) { return '[' + d.id + ']' })
 -->
